{% comment %}
Related posts or recent posts, depending on if the article is part of a
category or not.
{% endcomment %}

{% assign max_posts = 3 %}

{% comment %} Store the two h2 snippets to variables {% endcomment %}

{% assign placed_h2 = false %}

{% capture related_snippet %}
<!-- Related Posts -->
<aside role="complementary" class="related">
  <h2>Related Posts</h2>
  <div class="related-posts">
{% endcapture %}

{% capture recent_snippet %}
<!-- Recent Posts -->
<aside role="complementary" class="related">
  <h2>Recent Posts</h2>
  <div class="related-posts">
{% endcapture %}

{% capture close_h2 %}
  </div>
</aside>
{% endcapture %}

{% comment %} Try to get up to max_posts related posts {% endcomment %}

{% assign placed_articles = 0 %}
{% if page.categories != empty %}
  {% assign sorted = site.posts | sort: 'date' %}
  {% for post in sorted %}
    {% if placed_articles < 3 and post.url != page.url %}
      {% for category in page.categories %}
        {% if post.categories contains category %}
          {% comment %} Place the h2 if we haven't already {% endcomment %}
          {% if placed_h2 == false %}
            {{ related_snippet }}
            {% assign placed_h2 = true %}
          {% endif %}
          {% comment %} Place a related article {% endcomment %}
          {% include article_card.html
            url=post.url
            image=post.image
            image_alt=post.image_alt
            title=post.title
            description=post.description
          %}
          {% assign placed_articles = placed_articles | plus: 1 %}
          {% continue %} 
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endif %}

{% comment %} Fill in the remaining posts with recent ones {% endcomment %}

{% if site.related_posts != empty %}
  {% assign articles_left = max_posts | minus: placed_articles %}
  {% if articles_left > 0 %}
    {% comment %} Place the h2 if we haven't already {% endcomment %}
    {% if placed_h2 == false %}
      {{ recent_snippet }}
      {% assign placed_h2 = true %}
    {% endif %}
    {% comment %} Place a recent article {% endcomment %}
    {% for post in site.related_posts limit:articles_left %}
      {% include article_card.html
        url=post.url
        image=post.image
        image_alt=post.image_alt
        title=post.title
        description=post.description
      %}
      {% assign placed_articles = placed_articles | plus: 1 %}
    {% endfor %}
  {% endif %}
{% endif %}

{% comment %} Close the h2 divs if they were placed {% endcomment %}

{% if placed_h2 == true %}
  {{ close_h2 }}
{% endif %}
